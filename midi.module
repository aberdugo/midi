<?php

/**
 * @file
 * Midi File Module
 * A block module that diplays a midi-box for using Drupal File API to load a midi file.
 */

/**
 * Implements hook_help().
 *
 * Displays help and module information.
 *
 * @param path
 *   Which path of the site we're using to display help
 * @param arg
 *   Array that holds the current path as returned from arg() function
 */
function midi_help($path, $arg) {
  switch ($path) {
    case "admin/help#midi":
      return t("Displays a midi-box to load a midi file.");
      break;
  }
}

/*
 * Vamos a crear el bloque midi-box
 */

/**
 * Implements hook_block_info().
 *
 * La función hook_block_info() no tiene parámetros de entrada.
 * Devuelve un vector asociativo con la definición del bloque.
 */
function midi_block_info() {
  // Declaración del bloque
  $blocks['midi_block'] = array(
    // The name tha will appear in the block list.
    'info' => t('Midi box'), // (obligatorio). Nombre del bloque que aparecerá en el listado de bloques de administración. (Estructura/Bloques)
    // Default setting.
    'cache' => DRUPAL_CACHE_PER_ROLE, // (opcional). Define el tipo de caché.
  );

  return $blocks;
}

/**
 * Implements hook_theme().
 *
 * Creamos el elemento midi_box al que le vamos a asignar la plantilla midi-box.
 */
function midi_theme($existing, $type, $theme, $path) {
  return array(
    'midi_box' => array(
      'template' => 'midi-box',
      'variables' => array(),
    ),
  );
}

/**
 * Implements hook_block_view().
 *
 * Prepares the contents of the block.
 */
function midi_block_view($delta = '') {
  switch ($delta) {
    case 'midi_block':
      $block['subject'] = t('Mi primer bloque midi'); // Indicamos el título predeterminado del bloque. Si el bloque no tiene un título predeterminado, debemos indicar NULL.
      if (user_access('access content')) {
        $path = drupal_get_path('module', 'midi');
        $block['content'] = array( // El contenido del cuerpo del bloque. Esto deberá ser un vector renderizado (preferiblamente) o una cadena renderizada con contenido HTML.
          /*'part1' => array(
            '#markup' =>  midi_fileload_get_form(),
          ),*/
          'part2' => array(
            '#markup' =>  midi_savefile_get_form(),
          ),
          'part3' => array(
            '#theme' => 'midi_box',
            // '#markup' => theme('midi_box'), // t('Put here the form if could be.');
          ),
          '#attached' => array(
            'css' => array( // Agrega una hoja de estilos en cascada a la cola de la hoja de estilos.
              $path . '/css/midi-box.css',
            ),
            'js' => array( // Agrega un archivo JavaScript, configuración o código en línea a la página.
              $path . '/js/p5.js',
              $path . '/js/p5.dom.js',
              $path . '/js/p5.sound.js',
              $path . '/js/sketch.js',
              array(
                'data' => array('midi_module_path' => $path),
                'type' => 'setting',),
            ),
          ),
        );
      }
      return $block; // En vez de break; here
  }
  // y return $block here
}


/**
 *  Form constructor for the midi_fileload_form.
 */
function midi_fileload_form($form, &$form_state) {
  $form['file'] = array(
    '#type' => 'file',
    '#title' => t('Midi file'),
    '#description' => t('Upload a midi file, allowed extension: mid'),
  );

  $form['submitLoad'] = array(
    '#type' => 'submit',
    '#value' => t('Load Midi'),
  );

  return $form;
}


function midi_fileload_get_form() {
  $form = drupal_get_form('midi_fileload_form');
  $output = drupal_render($form);

  return $output;
}


/**
 * Validate handler for midi_fileload_form().
 *
 * @ingroup form_example
 */

function midi_fileload_form_validate($form, &$form_state) {
  $file = file_save_upload('file', array(
    // Validate extensions.
    'file_validate_extensions' => array('mid'),
  ), FALSE,
    FILE_EXISTS_REPLACE);
  // If the file passed validation:
  if ($file) {
    $form_state['storage']['file'] = $file;

    /*
    // Move the file into the Drupal file system.
    if ($file = file_move($file, 'temporary://')) {
      // Save the file for use in the submit handler.
      $form_state['storage']['file'] = $file;
    }
    else {
      form_set_error('file', t("Failed to move the uploaded file to the tmp site's file folder."));
    }
    */
  }
  else {
    form_set_error('file', t('No file was uploaded.'));
  }
}

/**
 * Submit handler for midi_fileload_form().
 *
 * @ingroup form_example
 */
function midi_fileload_form_submit($form, &$form_state) {
  $file = $form_state['storage']['file'];
  /*
  // We are done with the file, remove it from storage.
  unset($form_state['storage']['file']);
  // Make the storage of the file permanent.
  $file->status = FILE_STATUS_PERMANENT;
  // Save file status.
  file_save($file);
  */
  // Set a response to the user.
  drupal_set_message(t('The form has been submitted and the midi file has been saved temporarily, filename: @filename.', array('@filename' => $file->filename)));
}


/**
 *  Form constructor for the midi_savefile_form.
 */
function midi_savefile_form($form, &$form_state) {
  $form['msg'] = array(
    '#type' => 'markup',
    '#prefix' => '<div id="msg">',
    '#suffix' => '</div>',
  );

  $form['miditext'] = array(
    '#type' => 'textarea',
    '#title' => t(' Midi text '),
    '#required' => TRUE,
  );

  $form['submitCreate'] = array(
    '#type' => 'submit',
    '#value' => t('Save Midi file'),
    '#ajax' => array(
      'callback' => 'midi_savefile_submit_ajax_callback',
      'wrapper' => 'msg',
    ),
  );

  return $form;
}

function midi_savefile_get_form() {
  $form = drupal_get_form('midi_savefile_form');
  $output = drupal_render($form);

  return $output;
}


/**
 * Callback for save midi to DataBase.
 *
 * Select the 'box' element, change the markup in it, and return it as a
 * renderable array.
 *
 * @return array
 *   Renderable array (the box element)
 */

function midi_savefile_submit_ajax_callback($form, $form_state) {
  // In most cases, it is recommended that you put this logic in form generation
  // rather than the callback. Submit driven forms are an exception, because
  // you may not want to return the form at all.

  $element = $form['msg'];

  $stringMidi = $form_state['values']['miditext'];

  if (!empty($stringMidi)) {
    drupal_set_message(t("Clicked submit ({$form_state['values']['op']}): " . date('c')));
    $element['#markup'] = "Clicked submit ({$form_state['values']['op']}): " . date('c');

    if (strpos($stringMidi, 'MFile') !== false) {
      $midi = new Midi(); // Midi - CONSTRUCTOR // (midi-class.inc)
      $midi->importTxt($stringMidi); // importTxt - import whole MIDI song as text (mf2t-format) // (midi-class.inc)
      // midi_save_mid_file($midi);
      $binaryMidi = $midi->getMid();

      /*
      global $user;
      $file = file_save_data($binaryMidi,'private://' . $user->name . '.mid');
      */

      // $form_state['storage']['stringmidi'] = $stringMidi;
      // $form_state['rebuild'] = TRUE;
    }
    else {
      form_set_error('miditext', t('Midi text does not have the correct format.'));
    }
  }

  return $element;
}

/*
function midi_savefile_form_validate($form, &$form_state) {
  $stringMidi = $form_state['values']['miditext'];

  if (strpos($stringMidi, 'MFile') !== false) {
    $midi = new Midi(); // Midi - CONSTRUCTOR // (midi-class.inc)
    $midi->importTxt($stringMidi); // importTxt - import whole MIDI song as text (mf2t-format) // (midi-class.inc)
    // midi_save_mid_file($midi);

    // $form_state['storage']['stringmidi'] = $stringMidi;
    // $form_state['rebuild'] = TRUE;

    /*
    if ($file = file_move($file, 'temporary://')) {
      // Save the file for use in the submit handler.
      $form_state['storage']['stringMidi'] = $stringMidi;
    }
    else {
      form_set_error('file', t("Failed to move the  file to the tmp site's file folder."));
    }
    */
/*}
 else {
   form_set_error('miditext', t('Midi text does not have the correct format.'));
 }
}
*/

/*
function midi_save_mid_file(&$midi) {
  if (count($midi->tracks) < 1) {
    form_set_error('miditext', t('MIDI song has no tracks.'));
  }
  else {
    drupal_set_message(t('Hola.'));
  }
}
*/

/*
function midi_createfile_form_submit($form, &$form_state) {
  // $stringMidi = $form_state['storage']['stringmidi'];

  // Set a response to the user.
  drupal_set_message(t('Midi file has been created.'));
  drupal_set_message(t($form_state['values']['miditext']));
}
*/
/*
 * Para traducir los textos de dentro de la función t() (Configuración/REGIONAL E IDIOMA-Traducir interfaz/TRADUCIR)
 */